---
dependencies:
  - 'nginx'
install_packages:
  - 'aptly'
system_groups:
  - 'apt-repo-server'
system_users:
  - 'apt-repo-server'
install_files:
  - owner:              'root'
    group:              'root'
    mode:               '0644'
    src:                'files/conf/aptly.conf'
    dest:               '/home/apt-repo-server/.aptly.conf'
sync_dirs:
  # gpg --quick-gen-key --batch --passphrase '' apt-repo-server@apt.neuronpointer.net
  - src:                '../../sensitive_ansible/roles/apt-repo-server/files/gnupg/'
    dest:               '/home/apt-repo-server/.gnupg/'
    delete:             True
commands:
  - command:            'aptly repo create -distribution debian -component main -architectures amd64 general'
    creates:            '/home/apt-repo-server/repositories' 
  - command:            'aptly snapshot create general-0 from repo general && aptly publish -architectures amd64 snapshot general-0'
    creates:            '/home/apt-repo-server/repositories/public'
